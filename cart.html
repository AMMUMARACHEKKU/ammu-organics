<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ammu Organics — Cart & Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--green:#2f6f4e;--bg:#fbf6ef;--muted:#6b6b6b;--card:#fff;--radius:12px}
*{box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:var(--bg);margin:0;color:#163222}
.wrap{max-width:1150px;margin:30px auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.logo{background:linear-gradient(135deg,var(--green),#6b8a65);width:56px;height:56px;border-radius:12px;color:#fff;display:flex;align-items:center;justify-content:center}
.cart-grid{display:flex;gap:20px;align-items:flex-start}
@media(max-width:960px){.cart-grid{flex-direction:column}}
.left{flex:2;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.06)}
.right{flex:1;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.06)}
table{width:100%;border-collapse:collapse}
thead th{background:#f6f6f1;padding:12px;text-align:left}
tbody td{padding:12px;border-bottom:1px solid #f0f0f0;vertical-align:middle}
.product-cell{display:flex;gap:12px;align-items:center}
.product-cell img{width:78px;height:78px;object-fit:cover;border-radius:8px}
.qty-box{display:inline-flex;align-items:center;border-radius:8px;border:1px solid #eee;overflow:hidden}
.qty-btn{width:34px;height:34px;border:0;background:var(--green);color:#fff;cursor:pointer;font-weight:700}
.qty-input{width:54px;text-align:center;border:0;padding:6px 8px;background:#fff}
.remove-btn{background:#e74c3c;border:0;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.select,input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin:8px 0}
.btn{background:var(--green);color:#fff;padding:12px;border-radius:10px;border:0;cursor:pointer;width:100%;font-weight:700}
.small{font-size:13px;color:var(--muted)}
.summary-line{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
.total{display:flex;justify-content:space-between;font-weight:700;padding:12px 0;font-size:18px}
.note{font-size:13px;color:var(--muted);margin-top:10px}
.coupon-row{display:flex;gap:8px;margin-top:8px}
.coupon-row input{flex:1}
.success{color:green}
.error{color:red}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">AO</div>
      <div>
        <h2 style="margin:0">Ammu Organics</h2>
        <div class="small">Pure • Natural • Honest</div>
      </div>
    </div>
    <div class="small">Secure checkout • GST & Shipping included</div>
  </div>

  <div class="cart-grid">
    <!-- LEFT -->
    <div class="left" aria-live="polite">
      <h3>Your Cart</h3>
      <table>
        <thead>
          <tr><th style="width:44%">Product</th><th style="width:14%">Price</th><th style="width:18%">Qty</th><th style="width:14%">Subtotal</th><th style="width:10%">Remove</th></tr>
        </thead>
        <tbody id="cart-body"></tbody>
      </table>
      <div id="empty" style="display:none;padding:24px;text-align:center;color:var(--muted)">Your cart is empty — <a href="index.html">continue shopping</a></div>
    </div>

    <!-- RIGHT -->
    <aside class="right">
      <h3>Order Summary</h3>
      <div class="summary-line"><span>Subtotal</span><span>₹ <span id="subtotal">0.00</span></span></div>

      <h4 style="margin-top:14px">Coupon</h4>
      <div class="coupon-row">
        <input id="coupon" placeholder="Coupon code">
        <button class="btn secondary" id="applyCouponBtn" style="width:auto;padding:10px 12px;border:2px solid var(--green);background:#fff;color:var(--green)">Apply</button>
      </div>
      <div id="couponMsg" class="small" style="min-height:18px"></div>

      <h4 style="margin-top:12px">Shipping</h4>
      <label class="small">Country</label>
      <select id="country" class="select"><option value="India">India</option><option value="Other">Other</option></select>

      <label class="small">State</label>
      <select id="state" class="select"></select>

      <label class="small">District</label>
      <select id="district" class="select"></select>

      <label class="small">City</label>
      <select id="city" class="select"></select>

      <label class="small">Pincode</label>
      <input id="pincode" placeholder="Pincode" class="select">

      <button class="btn" id="updateShipping">Update Shipping</button>

      <div class="summary-line" style="margin-top:12px"><span>Shipping</span><span>₹ <span id="shipping">0.00</span></span></div>

      <div class="summary-line"><span>GST</span><span>₹ <span id="gstAmt">0.00</span></span></div>

      <div class="total"><span>Grand Total</span><span>₹ <span id="grandTotal">0.00</span></span></div>

      <div class="note" id="etaNote"></div>

      <button class="btn" id="checkoutBtn" style="margin-top:14px">Proceed to Payment</button>
      <div id="checkoutMsg" class="small" style="margin-top:8px"></div>
    </aside>
  </div>
</div>

<!-- Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
/* ---------- CONFIG ---------- */
const API_BASE = ''; // if backend is same origin leave '', otherwise 'https://your-backend.example'
const RAZORPAY_KEY_ID = 'RAZORPAY_KEY_ID'; // replace in server too
const SELLER_STATE = 'Tamil Nadu';

// Shipping rules
const SHIPPING = { TAMIL_NADU: 60, SOUTH: 80, REST: 120, FREE_ABOVE_TN: 999 };
const SOUTH_STATES = ['Tamil Nadu','Kerala','Karnataka','Andhra Pradesh','Telangana','Puducherry'];

// GST config
const GST_RATE = 0.05; // 5% default; adjust in server .env if needed

/* ---------- CART STORAGE ---------- */
function readCart(){ try{ const c = JSON.parse(localStorage.getItem('amu_cart')||'[]'); return Array.isArray(c)?c:[] }catch(e){return[]} }
function saveCart(cart){ localStorage.setItem('amu_cart', JSON.stringify(cart)); }

/* ---------- DOM ---------- */
const cartBody = document.getElementById('cart-body');
const emptyEl = document.getElementById('empty');
const subtotalEl = document.getElementById('subtotal');
const shippingEl = document.getElementById('shipping');
const gstEl = document.getElementById('gstAmt');
const grandEl = document.getElementById('grandTotal');
const etaNote = document.getElementById('etaNote');
const couponInput = document.getElementById('coupon');
const couponMsg = document.getElementById('couponMsg');
const checkoutMsg = document.getElementById('checkoutMsg');

/* region selects */
const countryEl = document.getElementById('country');
const stateEl = document.getElementById('state');
const districtEl = document.getElementById('district');
const cityEl = document.getElementById('city');
const pincodeEl = document.getElementById('pincode');

/* load cart and render */
let CART = readCart();
let appliedCoupon = null;

function renderCart(){
  cartBody.innerHTML = '';
  if(!CART.length){
    emptyEl.style.display = 'block';
    return;
  } else emptyEl.style.display = 'none';

  let subtotal = 0;
  CART.forEach((item, idx)=>{
    const line = (item.price||0) * (item.qty||1);
    subtotal += line;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div class="product-cell">
          <img src="${item.img || 'https://images.unsplash.com/photo-1606813902917-22c5c1da3a04?auto=format&fit=crop&w=600&q=80'}" alt="">
          <div>
            <div style="font-weight:700">${escapeHtml(item.product || item.name || 'Product')}</div>
            <div class="small">${escapeHtml(item.variant || '')}</div>
            <div class="small">SKU: ${escapeHtml(item.sku || '')}</div>
          </div>
        </div>
      </td>
      <td>₹ ${(item.price||0).toFixed(2)}</td>
      <td>
        <div class="qty-box">
          <button class="qty-btn" onclick="changeQty(${idx}, -1)">-</button>
          <input class="qty-input" type="number" min="1" value="${item.qty||1}" onchange="manualQty(${idx}, this.value)">
          <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
        </div>
      </td>
      <td>₹ ${line.toFixed(2)}</td>
      <td><button class="remove-btn" onclick="removeItem(${idx})">Remove</button></td>
    `;
    cartBody.appendChild(tr);
  });

  subtotalEl.innerText = subtotal.toFixed(2);
  recalcAll();
}

function changeQty(i, delta){ CART[i].qty = Math.max(1, (CART[i].qty||1) + delta); saveCart(CART); renderCart(); }
function manualQty(i,v){ CART[i].qty = Math.max(1, Number(v||1)); saveCart(CART); renderCart(); }
function removeItem(i){ if(!confirm('Remove item?')) return; CART.splice(i,1); saveCart(CART); renderCart(); }

/* ---------- REGION / SHIPPING ---------- */
// fetch region data from server, fallback to minimal local data
let REGION_DATA = null;
async function loadRegions(){
  try{
    const res = await fetch(API_BASE + '/api/regions');
    if(res.ok){ REGION_DATA = await res.json(); }
  }catch(e){ REGION_DATA = null; }
  if(!REGION_DATA){
    // minimal fallback including Tamil Nadu
    REGION_DATA = {
      "Tamil Nadu": { "Chennai":["Chennai"], "Coimbatore":["Coimbatore"], "Madurai":["Madurai"] },
      "Kerala": {"Thiruvananthapuram":["Thiruvananthapuram"]},
      "Karnataka": {"Bengaluru":["Bengaluru"]},
      "Other": {"Other District":["Other City"]}
    };
  }
  populateStates();
}
function populateStates(){
  stateEl.innerHTML = '';
  Object.keys(REGION_DATA).forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; stateEl.appendChild(o); });
  stateEl.value = 'Tamil Nadu';
  populateDistricts();
}
function populateDistricts(){
  const st = stateEl.value;
  districtEl.innerHTML = '';
  const districts = Object.keys(REGION_DATA[st]||{});
  districts.forEach(d => { const o = document.createElement('option'); o.value = d; o.textContent = d; districtEl.appendChild(o); });
  if(districts.length) populateCities();
  else { districtEl.innerHTML = '<option>Other</option>'; cityEl.innerHTML = '<option>Other</option>'; }
}
function populateCities(){
  const st = stateEl.value, d = districtEl.value;
  cityEl.innerHTML = '';
  const cities = (REGION_DATA[st] && REGION_DATA[st][d]) || ['Other'];
  cities.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; cityEl.appendChild(o); });
}

/* ---------- COUPON ---------- */
document.getElementById('applyCouponBtn').addEventListener('click', applyCoupon);
async function applyCoupon(){
  const code = couponInput.value.trim();
  if(!code){ couponMsg.innerHTML = '<span class="error">Enter coupon</span>'; return; }
  try{
    const res = await fetch(API_BASE + '/api/coupon/validate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, subtotal: getSubtotal() }) });
    const data = await res.json();
    if(res.ok && data.valid){ appliedCoupon = data; couponMsg.innerHTML = `<span class="success">Applied: ${data.desc}</span>`; recalcAll(); }
    else { appliedCoupon = null; couponMsg.innerHTML = `<span class="error">${data.error || 'Invalid coupon'}</span>`; recalcAll(); }
  }catch(e){ couponMsg.innerHTML = `<span class="error">Coupon check failed</span>`; }
}

/* ---------- CALCULATIONS (shipping + gst + coupon + total) ---------- */
function getSubtotal(){ return CART.reduce((s,it)=> s + ((it.price||0)*(it.qty||1)), 0); }

function recalcAll(){
  const subtotal = getSubtotal();
  let shipping = 0;
  if(countryEl.value !== 'India') shipping = SHIPPING.REST;
  else{
    const st = stateEl.value;
    if(st === 'Tamil Nadu'){
      shipping = (subtotal >= SHIPPING.FREE_ABOVE_TN) ? 0 : SHIPPING.TAMIL_NADU;
    } else if(SOUTH_STATES.includes(st)) shipping = SHIPPING.SOUTH;
    else shipping = SHIPPING.REST;
  }

  // coupon
  let discount = 0;
  if(appliedCoupon && appliedCoupon.valid){
    if(appliedCoupon.type === 'flat') discount = appliedCoupon.value;
    if(appliedCoupon.type === 'percent') discount = subtotal * (appliedCoupon.value/100);
    if(appliedCoupon.min && subtotal < appliedCoupon.min){ discount = 0; /* not eligible */ }
  }

  const taxable = Math.max(0, subtotal - discount);
  // GST: intrastate -> split CGST/SGST; interstate -> IGST
  let gst = 0;
  if(countryEl.value === 'India' && stateEl.value === SELLER_STATE){ // intrastate
    gst = taxable * GST_RATE; // we show total GST (split can be done server-side)
  } else {
    gst = taxable * GST_RATE; // IGST same rate here
  }

  const grand = Math.max(0, taxable + gst + shipping);

  // update UI
  subtotalEl.innerText = subtotal.toFixed(2);
  shippingEl.innerText = shipping.toFixed(2);
  gstEl.innerText = gst.toFixed(2);
  grandEl.innerText = grand.toFixed(2);

  // ETA note (simple)
  let eta = '5-8 business days';
  if(stateEl.value === 'Tamil Nadu') eta = '2-4 business days';
  else if(SOUTH_STATES.includes(stateEl.value)) eta = '3-6 business days';
  etaNote.innerText = `Estimated delivery: ${eta}`;

  return { subtotal, shipping, gst, discount, grand };
}

/* ---------- CHECKOUT FLOW ---------- */
document.getElementById('checkoutBtn').addEventListener('click', startCheckout);

async function startCheckout(){
  if(!CART.length){ alert('Cart is empty'); return; }
  const { subtotal, shipping, gst, discount, grand } = recalcAll();

  // prepare order payload
  const orderPayload = {
    items: CART,
    shipping: { country: countryEl.value, state: stateEl.value, district: districtEl.value, city: cityEl.value, pincode: pincodeEl.value },
    totals: { subtotal, shipping, gst, discount, grand },
    coupon: appliedCoupon ? appliedCoupon.code : null
  };

  // create order on server (secure) -> server returns { orderId, razorpayOrderId, amount }
  try{
    const res = await fetch(API_BASE + '/api/checkout/create-order', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(orderPayload)
    });
    const data = await res.json();
    if(!res.ok){ checkoutMsg.innerText = data.error || 'Create order failed'; return; }

    // open Razorpay with order id from server (server used secret to create)
    const options = {
      key: data.key || RAZORPAY_KEY_ID,
      amount: data.amount, // in paise
      currency: 'INR',
      name: 'Ammu Organics',
      description: 'Order #' + data.orderId,
      order_id: data.razorpayOrderId,
      handler: async function (resp){
        // send signature to server to verify
        const verifyRes = await fetch(API_BASE + '/api/checkout/verify', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
            razorpay_order_id: resp.razorpay_order_id,
            razorpay_payment_id: resp.razorpay_payment_id,
            razorpay_signature: resp.razorpay_signature,
            clientOrderId: data.orderId
          })
        });
        const verifyData = await verifyRes.json();
        if(verifyRes.ok && verifyData.ok){
          // success
          alert('Payment success. Order ID: ' + verifyData.orderId);
          // clear cart
          CART = [];
          saveCart(CART);
          renderCart();
        } else {
          alert('Payment verification failed');
        }
      },
      prefill: { name: '', email: '', contact: '' },
      theme: { color: '#2f6f4e' }
    };
    const rzp = new Razorpay(options);
    rzp.open();
  }catch(e){
    console.error(e);
    checkoutMsg.innerText = 'Checkout failed. Try again.';
  }
}

/* ---------- INIT ---------- */
stateEl.addEventListener('change', populateDistrictsFromLocal);
districtEl.addEventListener('change', populateCitiesFromLocal);
function populateDistrictsFromLocal(){ populateDistrictsUI(stateEl.value); }
function populateCitiesFromLocal(){ populateCitiesUI(stateEl.value, districtEl.value); }
function populateDistrictsUI(state){
  districtEl.innerHTML = '';
  const d = REGION_DATA[state] ? Object.keys(REGION_DATA[state]) : ['Other'];
  d.forEach(x => { const o = document.createElement('option'); o.value = x; o.textContent = x; districtEl.appendChild(o); });
  populateCitiesUI(state, districtEl.value);
}
function populateCitiesUI(state, district){
  cityEl.innerHTML = '';
  const c = (REGION_DATA[state] && REGION_DATA[state][district]) || ['Other'];
  c.forEach(x => { const o = document.createElement('option'); o.value = x; o.textContent = x; cityEl.appendChild(o); });
}

/* ---------- HELPERS ---------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- REGION DATA (client fallback; server can provide full list at /api/regions) ---------- */
let REGION_DATA = {
  "Tamil Nadu": { "Chennai":["Chennai","Adyar","T Nagar"], "Coimbatore":["Coimbatore"], "Madurai":["Madurai"] },
  "Kerala": {"Thiruvananthapuram":["Thiruvananthapuram"]},
  "Karnataka": {"Bengaluru":["Bengaluru"]},
  "Andhra Pradesh": {"Visakhapatnam":["Vizag"]},
  "Telangana": {"Hyderabad":["Hyderabad"]},
  "Maharashtra": {"Mumbai":["Mumbai"]},
  "Other": {"Other District":["Other City"]}
};

/* Try to load extended regions from server */
(async()=>{ await loadRegionsFromServer(); renderCart(); })();

async function loadRegionsFromServer(){
  try{
    const res = await fetch(API_BASE + '/api/regions');
    if(res.ok){ const json = await res.json(); if(Object.keys(json).length) REGION_DATA = json; }
  }catch(e){ /* ignore */ }
  populateStatesLocal();
}
function populateStatesLocal(){
  stateEl.innerHTML = ''; Object.keys(REGION_DATA).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stateEl.appendChild(o); });
  stateEl.value = 'Tamil Nadu'; populateDistrictsFromLocal();
}

/* ---------- INITIAL RENDER ---------- */
renderCart();

</script>
</body>
</html>
